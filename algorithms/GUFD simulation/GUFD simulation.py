from __future__ import division

"""
This is a template algorithm on Quantopian for you to adapt and fill in.
"""

from datetime import datetime
import quantopian.algorithm as algo
from quantopian.pipeline import Pipeline
from quantopian.pipeline.data.builtin import USEquityPricing
from quantopian.pipeline.filters import Q1500US



def initialize(context):
    """
    Called once at the start of the algorithm.
    """
    
    context.trailingstop_ratio = 0.10
    ##銘柄と日付リスト
    context.sid_date_list = [
        (symbol('DJCO'), '2013/11/27', -0.012022782092592844),
(symbol('DJCO'), '2014/03/04', -0.008379990358852148),
(symbol('DJCO'), '2014/06/17', -0.006108585325679041),
(symbol('DJCO'), '2014/08/07', -0.010756108469095568),
(symbol('ISTR'), '2014/09/12', -0.06249810156114424),
(symbol('FTEO'), '2014/10/23', -0.0341824094308699),
(symbol('DJCO'), '2014/12/31', -0.008379990358852148),
(symbol('COBZ'), '2015/01/23', -0.02333290543597753),
(symbol('CUTR'), '2015/01/23', -0.02333290543597753),
(symbol('CNET'), '2015/01/26', -0.03561767676683797),
(symbol('CRT'), '2015/01/29', -0.034087805208431396),
(symbol('CVCO'), '2015/01/29', -0.00963366943277046),
(symbol('CSIQ'), '2015/02/03', -0.0030550357717034483),
(symbol('DNR'), '2015/02/03', -0.0021557599753335007),
(symbol('CORI'), '2015/02/04', -0.03627316558474843),
(symbol('CMRE'), '2015/02/05', -0.004595383750330095),
(symbol('CONN'), '2015/02/05', -0.0034720830775678392),
(symbol('EARS'), '2015/02/06', -0.028267328497271905),
(symbol('DCM'), '2015/02/10', -0.018806207426204587),
(symbol('DGLY'), '2015/02/11', -0.0021557599753335007),
(symbol('CYBR'), '2015/02/13', -0.0021557599753335007),
(symbol('CYTK'), '2015/02/13', -0.0021557599753335007),
(symbol('CUR'), '2015/02/18', -0.0034720830775678392),
(symbol('CRMD'), '2015/02/20', -0.019223254732068977),
(symbol('CRWS'), '2015/02/20', -0.022695527111796954),
(symbol('CRME'), '2015/02/23', -0.008484703435922458),
(symbol('DGLY'), '2015/02/23', -0.004486617645544026),
(symbol('CSIQ'), '2015/02/24', -0.0021557599753335007),
(symbol('CYTX'), '2015/02/24', -0.00340345659899219),
(symbol('DERM'), '2015/02/24', -0.007779311705461745),
(symbol('CPRX'), '2015/02/25', -0.0021557599753335007),
(symbol('HMNY'), '2015/02/25', -0.02726350089239756),
(symbol('CREG'), '2015/02/26', -0.005702790449393835),
(symbol('CYCC'), '2015/02/27', -0.04724020965564463),
(symbol('CYTX'), '2015/02/27', -0.07242681795310159),
(symbol('CVM'), '2015/03/02', -0.0021557599753335007),
(symbol('IFON'), '2015/03/04', -0.018362387367817482),
(symbol('CREG'), '2015/03/05', -0.013123589084554521),
(symbol('CORT'), '2015/03/11', -0.0035355887423210107),
(symbol('CVGI'), '2015/03/11', -0.005911706852564433),
(symbol('CUR'), '2015/03/16', -0.006325071715784661),
(symbol('CRWS'), '2015/03/17', -0.0244825345919576),
(symbol('RTRX'), '2015/03/18', -0.006518739215779789),
(symbol('FOLD'), '2015/03/19', -0.006101691909915398),
(symbol('PRTA'), '2015/03/20', -0.0093951124176593),
(symbol('DERM'), '2015/03/23', -0.005628032355061478),
(symbol('DGLY'), '2015/03/24', -0.0021557599753335007),
(symbol('CRK'), '2015/03/26', -0.0034720830775678392),
(symbol('CUK'), '2015/03/27', -0.00269379460040788),
(symbol('CRMD'), '2015/03/30', -0.0021557599753335007),
(symbol('CORT'), '2015/04/21', -0.005012431056194486),
(symbol('CTIC'), '2015/04/22', -0.0030550357717034483),
(symbol('CNMD'), '2015/04/23', -0.00269379460040788),
(symbol('DPZ'), '2015/04/23', -0.0030550357717034483),
(symbol('CVM'), '2015/04/24', -0.00985683267272562),
(symbol('DGII'), '2015/04/24', -0.022609482454940887),
(symbol('DJCO'), '2015/04/24', -0.010756108469095568),
(symbol('CPAC'), '2015/04/28', -0.009829538276740882),
(symbol('CRI'), '2015/04/29', -0.002428422142270289),
(symbol('CSGP'), '2015/04/30', -0.0030550357717034483),
(symbol('CYTX'), '2015/05/04', -0.0021557599753335007),
(symbol('DBVT'), '2015/05/04', -0.010756108469095568),
(symbol('HIL'), '2015/05/04', -0.013897371561426609),
(symbol('CONN'), '2015/05/05', -0.0021557599753335007),
(symbol('DJCO'), '2015/05/05', -0.010756108469095568),
(symbol('CRAY'), '2015/05/06', -0.0030550357717034483),
(symbol('CPS'), '2015/05/08', -0.00963366943277046),
(symbol('CUTR'), '2015/05/08', -0.006866788783503204),
(symbol('MNGA'), '2015/05/15', -0.03120072145084149),
(symbol('SRPT'), '2015/05/20', -0.0030684995696263397),
(symbol('CYTR'), '2015/05/21', -0.0021557599753335007),
(symbol('CVCO'), '2015/05/22', -0.006944355457295817),
(symbol('HRTX'), '2015/05/29', -0.007166938184988151),
(symbol('CNBKA'), '2015/06/01', -0.022695527111796954),
(symbol('CTIC'), '2015/06/01', -0.0030550357717034483),
(symbol('DL'), '2015/06/01', -0.002219265640086672),
(symbol('CPST'), '2015/06/03', -0.005277626899787438),
(symbol('DISH'), '2015/06/04', -0.002428422142270289),
(symbol('CTIC'), '2015/06/10', -0.0021557599753335007),
(symbol('CRMD'), '2015/06/17', -0.008586722313843826),
(symbol('SGYP'), '2015/06/17', -0.010035678579864395),
(symbol('CPST'), '2015/06/19', -0.015791769884215046),
(symbol('CNIT'), '2015/06/22', -0.004486617645544026),
(symbol('DRAD'), '2015/06/24', -0.00804488195457622),
(symbol('CUR'), '2015/06/26', -0.004922640624600762),
(symbol('CPLP'), '2015/06/30', -0.004254284967046227),
(symbol('DEPO'), '2015/07/07', -0.00398761602498685),
(symbol('CYOU'), '2015/07/09', -0.00340345659899219),
(symbol('DQ'), '2015/07/09', -0.00340345659899219),
(symbol('DBVT'), '2015/07/10', -0.002219265640086672),
(symbol('DCM'), '2015/07/13', -0.004595383750330095),
(symbol('SHIP'), '2015/07/15', -0.02695688193095608),
(symbol('TESS'), '2015/07/17', -0.01469649547082975),
(symbol('EXEL'), '2015/07/20', -0.005907914070867009),
(symbol('VSLR'), '2015/07/20', -0.011230391312304147),
(symbol('CYTX'), '2015/07/28', -0.004029930276128747),
(symbol('DOX'), '2015/07/30', -0.007656799175193579),
(symbol('COLM'), '2015/07/31', -0.0030550357717034483),
(symbol('CPS'), '2015/07/31', -0.0072575513225270425),
(symbol('LXRX'), '2015/08/03', -0.006101691909915398),
(symbol('DLA'), '2015/08/04', -0.010756108469095568),
(symbol('CO'), '2015/08/06', -0.0021557599753335007),
(symbol('CPST'), '2015/08/07', -0.007343288726405009),
(symbol('CSOD'), '2015/08/07', -0.004069570339679635),
(symbol('CMT'), '2015/08/10', -0.00582191642097071),
(symbol('CVV'), '2015/08/13', -0.005628032355061478),
(symbol('IMUC'), '2015/08/13', -0.03945412213712436),
(symbol('CTSO'), '2015/08/14', -0.0021557599753335007),
(symbol('ONTX'), '2015/08/14', -0.013024751676641418),
(symbol('CSIQ'), '2015/08/25', -0.022697650370817384),
(symbol('CPG'), '2015/08/27', -0.004719779701226531),
(symbol('DNR'), '2015/08/27', -0.00340345659899219),
(symbol('DDD'), '2015/08/28', -0.0021557599753335007),
(symbol('TRVN'), '2015/09/01', -0.018745147931933947),
(symbol('CPAC'), '2015/09/03', -0.007292314892186236),
(symbol('CONN'), '2015/09/09', -0.0021557599753335007),
(symbol('CYTX'), '2015/09/10', -0.0031778933490300837),
(symbol('IVTY'), '2015/09/14', -0.057121713451702506),
(symbol('DBVT'), '2015/09/15', -0.0021557599753335007),
(symbol('CYAD'), '2015/09/16', -0.023112574417661343),
(symbol('CNAT'), '2015/09/23', -0.0021557599753335007),
(symbol('CREG'), '2015/09/23', -0.025231495989094778),
(symbol('CTIC'), '2015/09/23', -0.0021557599753335007),
(symbol('CNAT'), '2015/09/24', -0.029278231850614178),
(symbol('CRUS'), '2015/09/25', -0.003110841906272271),
(symbol('XOMA'), '2015/10/01', -0.0071593053779848825),
(symbol('CNX'), '2015/10/05', -0.0021557599753335007),
(symbol('CVM'), '2015/10/05', -0.007841955733777769),
(symbol('CYTR'), '2015/10/05', -0.007779311705461745),
(symbol('CUTR'), '2015/10/06', -0.012596418926008142),
(symbol('CVRS'), '2015/10/06', -0.006279104679691763),
(symbol('CSLT'), '2015/10/09', -0.0021557599753335007),
(symbol('DRAD'), '2015/10/14', -0.005626946717066527),
(symbol('FPRX'), '2015/10/15', -0.029084150213892195),
(symbol('DLA'), '2015/10/21', -0.018016345640284342),
(symbol('CTXS'), '2015/10/22', -0.006945943541559148),
(symbol('CONN'), '2015/10/23', -0.0021557599753335007),
(symbol('CYAD'), '2015/10/23', -0.00923959017750041),
(symbol('CYBE'), '2015/10/23', -0.027639272427434285),
(symbol('IMMY'), '2015/10/23', -0.022560758329195314),
(symbol('CSIQ'), '2015/10/26', -0.0034720830775678392),
(symbol('CYAD'), '2015/10/26', -0.01129841336229354),
(symbol('CYOU'), '2015/10/26', -0.0031743475710254423),
(symbol('CRY'), '2015/10/27', -0.006866788783503204),
(symbol('RVNC'), '2015/10/29', -0.006518739215779789),
(symbol('CVCO'), '2015/10/30', -0.004490670673259782),
(symbol('CUTR'), '2015/11/03', -0.009751377059419735),
(symbol('DPLO'), '2015/11/04', -0.0021557599753335007),
(symbol('CVU'), '2015/11/05', -0.009439785366861228),
(symbol('CYTX'), '2015/11/05', -0.0026363129459510627),
(symbol('CORT'), '2015/11/06', -0.005012431056194486),
(symbol('CYAD'), '2015/11/06', -0.00985683267272562),
(symbol('DMLP'), '2015/11/06', -0.004595383750330095),
(symbol('LXRX'), '2015/11/06', -0.006518739215779789),
(symbol('DMRC'), '2015/11/13', -0.005012431056194486),
(symbol('CYAD'), '2015/11/17', -0.015382200859510683),
(symbol('DBVT'), '2015/11/18', -0.0030550357717034483),
(symbol('CTIC'), '2015/11/23', -0.0021557599753335007),
(symbol('DGLY'), '2015/11/25', -0.0036584463196476457),
(symbol('CNHI'), '2015/11/27', -0.0030550357717034483),
(symbol('CPSI'), '2015/11/30', -0.00340345659899219),
(symbol('CYTX'), '2015/11/30', -0.008901750741786849),
(symbol('CONN'), '2015/12/01', -0.0021557599753335007),
(symbol('ONDK'), '2015/12/02', -0.025523816334790336),
(symbol('CTIC'), '2015/12/07', -0.007347205089481244),
(symbol('TXMD'), '2015/12/08', -0.02503162229217181),
(symbol('CVO'), '2015/12/10', -0.03321157941838967),
(symbol('CYAD'), '2015/12/10', -0.01117315577495996),
(symbol('DGLY'), '2015/12/10', -0.00955322877828977),
(symbol('DMRC'), '2015/12/10', -0.005012431056194486),
(symbol('CSIQ'), '2015/12/16', -0.0021557599753335007),
(symbol('CYTK'), '2015/12/16', -0.0021557599753335007),
(symbol('DCM'), '2015/12/16', -0.00269379460040788),
(symbol('CVM'), '2015/12/17', -0.008901750741786849),
(symbol('CVRS'), '2015/12/17', -0.014544073260556355),
(symbol('CYTX'), '2015/12/17', -0.008923951192910765),
(symbol('RWLK'), '2015/12/17', -0.09801494675655965),
(symbol('DMLP'), '2015/12/21', -0.008133462407000478),
(symbol('CYAD'), '2015/12/24', -0.011629564473759938),
(symbol('DMRC'), '2016/01/07', -0.0026363129459510627),
(symbol('SIEN'), '2016/01/08', -0.042401802434456425),
(symbol('JNP'), '2016/01/11', -0.03223779246325766),
(symbol('DMRC'), '2016/01/12', -0.0034720830775678392),
(symbol('DGLY'), '2016/01/15', -0.003952636048185402),
(symbol('ZFGN'), '2016/01/20', -0.02928331870416925),
(symbol('CUBI'), '2016/01/21', -0.00269379460040788),
(symbol('CNQ'), '2016/01/22', -0.0034720830775678392),
(symbol('CPE'), '2016/01/22', -0.005741913074923114),
(symbol('CPG'), '2016/01/22', -0.00340345659899219),
(symbol('CRC'), '2016/01/22', -0.011811446082512724),
(symbol('CRK'), '2016/01/22', -0.0094805884123022),
(symbol('CRR'), '2016/01/22', -0.00340345659899219),
(symbol('CXO'), '2016/01/22', -0.0034720830775678392),
(symbol('CYAD'), '2016/01/22', -0.010168424365284126),
(symbol('DRAD'), '2016/01/26', -0.005012431056194486),
(symbol('CMPR'), '2016/01/28', -0.00606185068974773),
(symbol('CNQ'), '2016/01/28', -0.0034720830775678392),
(symbol('CPF'), '2016/01/28', -0.004490670673259782),
(symbol('CPG'), '2016/01/28', -0.004719779701226531),
(symbol('COHR'), '2016/01/29', -0.014760909391612254),
(symbol('CPL'), '2016/01/29', -0.004595383750330095),
(symbol('CVCO'), '2016/01/29', -0.007362264399597354),
(symbol('DCM'), '2016/01/29', -0.00269379460040788),
(symbol('DLNG'), '2016/02/03', -0.0021557599753335007),
(symbol('CORI'), '2016/02/04', -0.008550509712864869),
(symbol('COTY'), '2016/02/04', -0.0035355887423210107),
(symbol('CSTE'), '2016/02/04', -0.004595383750330095),
(symbol('CYAD'), '2016/02/04', -0.01718012083378539),
(symbol('CTRL'), '2016/02/05', -0.0021557599753335007),
(symbol('CUTR'), '2016/02/09', -0.004505593318736371),
(symbol('CRTO'), '2016/02/10', -0.004029930276128747),
(symbol('CSTE'), '2016/02/10', -0.0021557599753335007),
(symbol('CSCO'), '2016/02/11', -0.004010117702642219),
(symbol('CSRA'), '2016/02/11', -0.004486617645544026),
(symbol('CUI'), '2016/02/11', -0.0021557599753335007),
(symbol('DDD'), '2016/02/11', -0.009066871465228318),
(symbol('DLA'), '2016/02/11', -0.012022782092592844),
(symbol('CRT'), '2016/02/12', -0.01005071673863485),
(symbol('DB'), '2016/02/12', -0.0021557599753335007),
(symbol('CXO'), '2016/02/17', -0.0021557599753335007),
(symbol('DAC'), '2016/02/17', -0.010168424365284126),
(symbol('RGLS'), '2016/02/17', -0.01699311409021017),
(symbol('CPIX'), '2016/02/18', -0.022302309492964054),
(symbol('DAVE'), '2016/02/18', -0.01117315577495996),
(symbol('COMM'), '2016/02/19', -0.004069570339679635),
(symbol('CPG'), '2016/02/22', -0.0021557599753335007),
(symbol('CPL'), '2016/02/22', -0.004595383750330095),
(symbol('CRAI'), '2016/02/22', -0.005460675249675142),
(symbol('DIT'), '2016/02/22', -0.009751377059419735),
(symbol('CRI'), '2016/02/25', -0.00269379460040788),
(symbol('DL'), '2016/02/25', -0.007362264399597354),
(symbol('DOOR'), '2016/02/25', -0.0030550357717034483),
(symbol('CTSO'), '2016/02/26', -0.0021557599753335007),
(symbol('VSLR'), '2016/02/26', -0.006518739215779789),
(symbol('CNX'), '2016/02/29', -0.0021557599753335007),
(symbol('CYAD'), '2016/03/02', -0.012439829398457235),
(symbol('DLA'), '2016/03/02', -0.007528535866988739),
(symbol('DB'), '2016/03/03', -0.0021557599753335007),
(symbol('CPL'), '2016/03/04', -0.002219265640086672),
(symbol('CRC'), '2016/03/04', -0.010129635005575066),
(symbol('CRC'), '2016/03/07', -0.004522478275330248),
(symbol('CRK'), '2016/03/07', -0.020972839329900374),
(symbol('CPL'), '2016/03/09', -0.002219265640086672),
(symbol('CRZO'), '2016/03/11', -0.004719779701226531),
(symbol('SSKN'), '2016/03/11', -0.015207670633236314),
(symbol('CVM'), '2016/03/14', -0.01968108956980742),
(symbol('DDD'), '2016/03/14', -0.0021557599753335007),
(symbol('CTIC'), '2016/03/15', -0.03338090218457741),
(symbol('CPL'), '2016/03/17', -0.0026363129459510627),
(symbol('CYAD'), '2016/03/18', -0.023112574417661343),
(symbol('GNCA'), '2016/03/31', -0.02654525280479633),
(symbol('CYAD'), '2016/04/06', -0.023112574417661343),
(symbol('DRIO'), '2016/04/07', -0.028891431607325258),
(symbol('DRAD'), '2016/04/19', -0.016534802393031484),
(symbol('CORI'), '2016/04/22', -0.037395604621073546),
(symbol('CRAI'), '2016/04/28', -0.004595383750330095),
(symbol('DRAD'), '2016/04/29', -0.009439785366861228),
(symbol('CYAD'), '2016/05/02', -0.00604507966092587),
(symbol('DCM'), '2016/05/02', -0.00269379460040788),
(symbol('CTS'), '2016/05/03', -0.0031743475710254423),
(symbol('CSII'), '2016/05/05', -0.0021557599753335007),
(symbol('CRME'), '2016/05/06', -0.005877722555539533),
(symbol('CTRL'), '2016/05/06', -0.004595383750330095),
(symbol('DEPO'), '2016/05/09', -0.0021557599753335007),
(symbol('CROX'), '2016/05/10', -0.004069570339679635),
(symbol('CYTX'), '2016/05/10', -0.00340345659899219),
(symbol('CVO'), '2016/05/11', -0.031528148145409406),
(symbol('DAVE'), '2016/05/17', -0.022346598163898005),
(symbol('NETE'), '2016/05/17', -0.023753296274392956),
(symbol('CSLT'), '2016/05/18', -0.0021557599753335007),
(symbol('CORI'), '2016/05/19', -0.027764530014767867),
(symbol('ORIG'), '2016/05/20', -0.015785929888525348),
(symbol('CRC'), '2016/05/26', -0.0021557599753335007),
(symbol('CYAN'), '2016/06/02', -0.0355489453169072),
(symbol('DERM'), '2016/06/02', -0.0021557599753335007),
(symbol('CTIC'), '2016/06/07', -0.005012431056194486),
(symbol('SRPT'), '2016/06/07', -0.0035042341324022183),
(symbol('GEVO'), '2016/06/08', -0.0351035791208286),
(symbol('CYAD'), '2016/06/15', -0.022280564931242766),
(symbol('CTIC'), '2016/06/17', -0.0021557599753335007),
(symbol('IMNP'), '2016/06/21', -0.07956634530578452),
(symbol('CVV'), '2016/06/23', -0.011546118860785947),
(symbol('DJCO'), '2016/06/23', -0.010756108469095568),
(symbol('DRD'), '2016/06/24', -0.0021557599753335007),
(symbol('CRK'), '2016/06/28', -0.006260127679853176),
(symbol('CUR'), '2016/06/28', -0.018558650533482313),
(symbol('CVCY'), '2016/06/29', -0.016534802393031484),
(symbol('CYCC'), '2016/06/29', -0.05028812287652479),
(symbol('DAR'), '2016/06/29', -0.0035355887423210107),
(symbol('CRCM'), '2016/06/30', -0.010179168445197187),
(symbol('DGLY'), '2016/07/08', -0.02448859442448714),
(symbol('DB'), '2016/07/12', -0.0021557599753335007),
(symbol('SAGE'), '2016/07/12', -0.014338468349643183),
(symbol('CVO'), '2016/07/19', -0.006260127679853176),
(symbol('HDSN'), '2016/07/19', -0.0036797398381958587),
(symbol('TOPS'), '2016/07/21', -0.09384453924338405),
(symbol('CNOB'), '2016/07/22', -0.010756108469095568),
(symbol('CRY'), '2016/07/26', -0.0030550357717034483),
(symbol('PCMI'), '2016/07/28', -0.038875862881835324),
(symbol('DECK'), '2016/07/29', -0.002428422142270289),
(symbol('DGII'), '2016/07/29', -0.008628938023094626),
(symbol('TOPS'), '2016/08/01', -0.0159439855536812),
(symbol('CPA'), '2016/08/04', -0.006866788783503204),
(symbol('CXDC'), '2016/08/05', -0.010779938156127052),
(symbol('CSLT'), '2016/08/09', -0.003213756589262402),
(symbol('CVG'), '2016/08/09', -0.00269379460040788),
(symbol('COTV'), '2016/08/10', -0.0030550357717034483),
(symbol('KURA'), '2016/08/11', -0.006095112410841501),
(symbol('CYBE'), '2016/08/12', -0.023112574417661343),
(symbol('CYCC'), '2016/08/12', -0.015899984976979156),
(symbol('CTRN'), '2016/08/17', -0.0030550357717034483),
(symbol('CUO'), '2016/08/17', -0.00882254287163602),
(symbol('DGLY'), '2016/08/18', -0.0021557599753335007),
(symbol('CRMT'), '2016/08/19', -0.005460675249675142),
(symbol('CSPI'), '2016/08/19', -0.005628032355061478),
(symbol('CYCC'), '2016/08/22', -0.0195466986129055),
(symbol('DFBG'), '2016/08/25', -0.006397684544394053),
(symbol('CTIC'), '2016/08/29', -0.004922640624600762),
(symbol('DLTH'), '2016/09/09', -0.0030550357717034483),
(symbol('CUR'), '2016/09/12', -0.0034720830775678392),
(symbol('DGLY'), '2016/09/20', -0.007779311705461745),
(symbol('CONN'), '2016/09/21', -0.005802940747778365),
(symbol('DRD'), '2016/09/21', -0.005012431056194486),
(symbol('CORR'), '2016/09/22', -0.00269379460040788),
(symbol('CRBP'), '2016/09/28', -0.0021557599753335007),
(symbol('CRBP'), '2016/10/05', -0.0021557599753335007),
(symbol('DCUD'), '2016/10/11', -0.005862057373827371),
(symbol('DGLY'), '2016/10/14', -0.00604507966092587),
(symbol('CRK'), '2016/10/17', -0.0021557599753335007),
(symbol('DRD'), '2016/10/19', -0.0063287541584288245),
(symbol('COGT'), '2016/10/20', -0.01819954632255456),
(symbol('CTG'), '2016/10/20', -0.021420604613732182),
(symbol('CSV'), '2016/10/26', -0.005460675249675142),
(symbol('CO'), '2016/10/27', -0.005862057373827371),
(symbol('CRAI'), '2016/10/27', -0.018806207426204587),
(symbol('CUBI'), '2016/10/27', -0.002219265640086672),
(symbol('IMNP'), '2016/10/27', -0.037681690771911705),
(symbol('PRQR'), '2016/10/27', -0.020743269458950997),
(symbol('COHU'), '2016/10/28', -0.010900343056267735),
(symbol('CTS'), '2016/10/28', -0.005550465681268865),
(symbol('DAIO'), '2016/10/28', -0.00582191642097071),
(symbol('CNA'), '2016/10/31', -0.007656799175193579),
(symbol('DFBG'), '2016/11/01', -0.02651683339110918),
(symbol('CNO'), '2016/11/02', -0.004595383750330095),
(symbol('CXRX'), '2016/11/02', -0.0031778933490300837),
(symbol('COHR'), '2016/11/03', -0.0030550357717034483),
(symbol('CUI'), '2016/11/04', -0.034087805208431396),
(symbol('CTSO'), '2016/11/08', -0.005012431056194486),
(symbol('CNCE'), '2016/11/09', -0.004595383750330095),
(symbol('CTIC'), '2016/11/09', -0.008628938023094626),
(symbol('CVRR'), '2016/11/09', -0.020574868839389554),
(symbol('CXDC'), '2016/11/09', -0.004505593318736371),
(symbol('DERM'), '2016/11/09', -0.0030550357717034483),
(symbol('DRD'), '2016/11/09', -0.0021557599753335007),
(symbol('CNCE'), '2016/11/10', -0.00340345659899219),
(symbol('COT'), '2016/11/10', -0.00269379460040788),
(symbol('CSRA'), '2016/11/10', -0.00269379460040788),
(symbol('CVRR'), '2016/11/10', -0.008531532713026284),
(symbol('DGII'), '2016/11/14', -0.004315170148761244),
(symbol('CUO'), '2016/11/16', -0.008484703435922458),
(symbol('DJCO'), '2016/11/18', -0.006108585325679041),
(symbol('CRK'), '2016/11/21', -0.0021557599753335007),
(symbol('CTIC'), '2016/11/22', -0.007779311705461745),
(symbol('CYTR'), '2016/11/29', -0.0021557599753335007),
(symbol('CPE'), '2016/11/30', -0.0030550357717034483),
(symbol('CPG'), '2016/11/30', -0.00269379460040788),
(symbol('CRC'), '2016/11/30', -0.0063607879463392705),
(symbol('CRK'), '2016/11/30', -0.0021557599753335007),
(symbol('CRR'), '2016/11/30', -0.0063287541584288245),
(symbol('CRVS'), '2016/11/30', -0.027639272427434285),
(symbol('DRQ'), '2016/11/30', -0.0031743475710254423),
(symbol('CRZO'), '2016/12/01', -0.0021557599753335007),
(symbol('DCI'), '2016/12/01', -0.0030550357717034483),
(symbol('DNR'), '2016/12/01', -0.00340345659899219),
(symbol('CTIC'), '2016/12/02', -0.0021557599753335007),
(symbol('CSWC'), '2016/12/05', -0.024092077024566606),
(symbol('DRIO'), '2016/12/05', -0.02234889847984148),
(symbol('CONN'), '2016/12/06', -0.0021557599753335007),
(symbol('COUP'), '2016/12/06', -0.004069570339679635),
(symbol('CTMX'), '2016/12/06', -0.0021557599753335007),
(symbol('DB'), '2016/12/06', -0.0030550357717034483),
(symbol('TLRD'), '2016/12/08', -0.00897806511179491),
(symbol('CVRR'), '2016/12/09', -0.003110841906272271),
(symbol('CRR'), '2016/12/12', -0.0021557599753335007),
(symbol('CSOD'), '2016/12/12', -0.0021557599753335007),
(symbol('DNR'), '2016/12/12', -0.0021557599753335007),
(symbol('DO'), '2016/12/12', -0.0021557599753335007),
(symbol('DRQ'), '2016/12/12', -0.004490670673259782),
(symbol('CYRX'), '2016/12/13', -0.00870923053042382),
(symbol('DCIX'), '2016/12/16', -0.07196044995048163),
(symbol('TNXP'), '2016/12/19', -0.021438936405318347),
(symbol('DCIX'), '2016/12/21', -0.034730182912723694),
(symbol('CVRR'), '2016/12/22', -0.0021557599753335007),
(symbol('CO'), '2016/12/30', -0.006056289782468926),
(symbol('CRSP'), '2017/01/04', -0.0021557599753335007),
(symbol('CTIC'), '2017/01/05', -0.002152337130342004),
(symbol('MACK'), '2017/01/09', -0.014149340409505603),
(symbol('CTMX'), '2017/01/10', -0.022693465670013808),
(symbol('CMRX'), '2017/01/18', -0.0021557599753335007),
(symbol('CRNT'), '2017/01/18', -0.0021557599753335007),
(symbol('CYAD'), '2017/01/18', -0.023112574417661343),
(symbol('CNFR'), '2017/01/24', -0.03585611827888404),
(symbol('CRR'), '2017/01/26', -0.0021557599753335007),
(symbol('DQ'), '2017/01/27', -0.005628032355061478),
(symbol('DGLY'), '2017/01/30', -0.010194672108439181),
(symbol('CTIC'), '2017/01/31', -0.0021557599753335007),
(symbol('DCIX'), '2017/01/31', -0.006558896493818694),
(symbol('DM'), '2017/02/01', -0.002219265640086672),
(symbol('COG'), '2017/02/06', -0.0030550357717034483),
(symbol('CRR'), '2017/02/06', -0.0021557599753335007),
(symbol('CYTK'), '2017/02/06', -0.0030550357717034483),
(symbol('CVCO'), '2017/02/07', -0.006108585325679041),
(symbol('COKE'), '2017/02/08', -0.006108585325679041),
(symbol('DFFN'), '2017/02/08', -0.045141961283216236),
(symbol('CRAY'), '2017/02/09', -0.00269379460040788),
(symbol('CPSI'), '2017/02/10', -0.0030550357717034483),
(symbol('SHLD'), '2017/02/10', -0.006518739215779789),
(symbol('CRESY'), '2017/02/13', -0.00269379460040788),
(symbol('CRL'), '2017/02/14', -0.0030550357717034483),
(symbol('DFFN'), '2017/02/14', -0.03645341059528853),
(symbol('CRAI'), '2017/02/16', -0.002219265640086672),
(symbol('CSLT'), '2017/02/16', -0.0030550357717034483),
(symbol('DENN'), '2017/02/16', -0.0030550357717034483),
(symbol('MDGS'), '2017/02/16', -0.008108386841357562),
(symbol('XTLB'), '2017/02/16', -0.049181537255965226),
(symbol('CXDC'), '2017/02/17', -0.007656799175193579),
(symbol('DCIX'), '2017/02/17', -0.00729277628458456),
(symbol('TOPS'), '2017/02/17', -0.05485244657634166),
(symbol('COOL'), '2017/02/22', -0.005012431056194486),
(symbol('DEL'), '2017/02/22', -0.005628032355061478),
(symbol('DEPO'), '2017/02/22', -0.003213756589262402),
(symbol('DL'), '2017/02/22', -0.00269379460040788),
(symbol('MBOT'), '2017/02/22', -0.012505027281692851),
(symbol('DOOR'), '2017/02/23', -0.0030550357717034483),
(symbol('DAIO'), '2017/02/24', -0.012634295883435771),
(symbol('DRAD'), '2017/02/24', -0.006944355457295817),
(symbol('CTG'), '2017/02/27', -0.006108585325679041),
(symbol('DAIO'), '2017/02/27', -0.002219265640086672),
(symbol('CMT'), '2017/02/28', -0.027222225121569896),
(symbol('CYAD'), '2017/02/28', -0.012439829398457235),
(symbol('DVAX'), '2017/03/01', -0.005490866765002617),
(symbol('SGY'), '2017/03/01', -0.013529433097675368),
(symbol('CRCM'), '2017/03/09', -0.0030550357717034483),
(symbol('CNTY'), '2017/03/10', -0.007362264399597354),
(symbol('COBZ'), '2017/03/10', -0.004595383750330095),
(symbol('CYAD'), '2017/03/10', -0.023112574417661343),
(symbol('CRVS'), '2017/03/13', -0.019257803482530297),
(symbol('COKE'), '2017/03/14', -0.006583114286000249),
(symbol('CTB'), '2017/03/14', -0.00269379460040788),
(symbol('CYCC'), '2017/03/16', -0.02735907102159836),
(symbol('CPSS'), '2017/03/17', -0.004595383750330095),
(symbol('CTMX'), '2017/03/20', -0.002152337130342004),
(symbol('PTIE'), '2017/03/21', -0.011147500779253035),
(symbol('CPIX'), '2017/03/23', -0.02651683339110918),
(symbol('CORI'), '2017/03/28', -0.02374995274184192),
(symbol('CRSP'), '2017/03/28', -0.0021557599753335007),
(symbol('CYCC'), '2017/03/30', -0.03144618214649771),
(symbol('CRME'), '2017/04/03', -0.004595383750330095),
(symbol('NVCR'), '2017/04/03', -0.01842881791100102),
(symbol('CONN'), '2017/04/04', -0.004486617645544026),
(symbol('CYCC'), '2017/04/04', -0.03915272143160617),
(symbol('PRTK'), '2017/04/04', -0.016026933555292347),
(symbol('NOVN'), '2017/04/12', -0.004870440022248777),
(symbol('DBVT'), '2017/04/24', -0.009945261125328966),
(symbol('CTIC'), '2017/04/25', -0.004505593318736371),
(symbol('CRNT'), '2017/04/26', -0.002219265640086672),
(symbol('CSTM'), '2017/04/27', -0.005012431056194486),
(symbol('DGLY'), '2017/04/27', -0.007779311705461745),
(symbol('SSKN'), '2017/04/27', -0.025204726845111682),
(symbol('COWN'), '2017/04/28', -0.004486617645544026),
(symbol('CVLT'), '2017/05/03', -0.0030550357717034483),
(symbol('CNAT'), '2017/05/04', -0.00340345659899219),
(symbol('CRAI'), '2017/05/04', -0.006866788783503204),
(symbol('DATA'), '2017/05/04', -0.002113445724191603),
(symbol('DFIN'), '2017/05/04', -0.002219265640086672),
(symbol('CTMX'), '2017/05/05', -0.006866788783503204),
(symbol('CWH'), '2017/05/05', -0.02111216120983901),
(symbol('DAIO'), '2017/05/05', -0.004595383750330095),
(symbol('DCO'), '2017/05/05', -0.006866788783503204),
(symbol('CVU'), '2017/05/09', -0.027004482056373704),
(symbol('DLA'), '2017/05/09', -0.004490670673259782),
(symbol('CROX'), '2017/05/10', -0.0030550357717034483),
(symbol('CSLT'), '2017/05/10', -0.0021557599753335007),
(symbol('CORI'), '2017/05/11', -0.0021557599753335007),
(symbol('CYAD'), '2017/05/11', -0.010149447365445539),
(symbol('DHXM'), '2017/05/11', -0.008590985350063697),
(symbol('SGMO'), '2017/05/11', -0.004327523683747483),
(symbol('CYCC'), '2017/05/12', -0.0021557599753335007),
(symbol('DHXM'), '2017/05/12', -0.006260127679853176),
(symbol('CRC'), '2017/05/15', -0.0021557599753335007),
(symbol('VNCE'), '2017/05/19', -0.04652572564763363),
(symbol('CRMT'), '2017/05/23', -0.002219265640086672),
(symbol('DEST'), '2017/05/23', -0.019718730348163134),
(symbol('DCIX'), '2017/05/24', -0.022716942417178095),
(symbol('INO'), '2017/05/24', -0.008354018110424634),
(symbol('TCS'), '2017/05/24', -0.016473829040718743),
(symbol('CYAD'), '2017/05/25', -0.008901750741786849),
(symbol('CUR'), '2017/06/01', -0.005012431056194486),
(symbol('CVU'), '2017/06/01', -0.004922640624600762),
(symbol('CRSP'), '2017/06/02', -0.005862057373827371),
(symbol('DEL'), '2017/06/02', -0.021573088075471848),
(symbol('COOL'), '2017/06/08', -0.00340345659899219),
(symbol('CYTR'), '2017/06/08', -0.007606418111506957),
(symbol('CYRX'), '2017/06/12', -0.0021557599753335007),
(symbol('DATA'), '2017/06/13', -0.0030550357717034483),
(symbol('CRVS'), '2017/06/14', -0.0021557599753335007),
(symbol('HTGM'), '2017/06/15', -0.006518739215779789),
(symbol('CO'), '2017/06/22', -0.0021557599753335007),
(symbol('DLHC'), '2017/06/23', -0.02651683339110918),
(symbol('SNCR'), '2017/06/23', -0.03095032813196895),
(symbol('CYRX'), '2017/07/25', -0.0059675129871332565),
(symbol('DCIX'), '2017/07/25', -0.002995426535082795),
(symbol('CYRX'), '2017/07/26', -0.0021557599753335007),
(symbol('CRAI'), '2017/07/27', -0.007506219769401681),
(symbol('CRR'), '2017/07/27', -0.0026363129459510627),
(symbol('CUI'), '2017/07/27', -0.02651683339110918),
(symbol('CYAD'), '2017/08/03', -0.022695527111796954),
(symbol('COOL'), '2017/08/04', -0.005012431056194486),
(symbol('DCO'), '2017/08/04', -0.004505593318736371),
(symbol('CRK'), '2017/08/07', -0.004595383750330095),
(symbol('CTSO'), '2017/08/08', -0.0036943095598799642),
(symbol('CSWI'), '2017/08/09', -0.004490670673259782),
(symbol('CUI'), '2017/08/09', -0.011317390362132126),
(symbol('DIN'), '2017/08/10', -0.006866788783503204),
(symbol('DCIX'), '2017/08/11', -0.026952826002377358),
(symbol('COOL'), '2017/08/14', -0.004922640624600762),
(symbol('CUI'), '2017/08/14', -0.03421306279576498),
(symbol('CVTI'), '2017/08/14', -0.004010117702642219),
(symbol('EBR'), '2017/08/22', -0.006101691909915398),
(symbol('ITCI'), '2017/08/23', -0.006101691909915398),
(symbol('DLTR'), '2017/08/24', -0.002113445724191603),
(symbol('DK'), '2017/08/28', -0.0034720830775678392),
(symbol('IXYS'), '2017/08/28', -0.009002217079632996),
(symbol('TNDM'), '2017/08/28', -0.003982199367868878),
(symbol('CTLT'), '2017/08/29', -0.004595383750330095),
(symbol('DLA'), '2017/09/01', -0.004922640624600762),
(symbol('VSTM'), '2017/09/06', -0.0030684995696263397),
(symbol('RH'), '2017/09/07', -0.011230391312304147),
(symbol('CTEK'), '2017/09/08', -0.021990135381336238),
(symbol('DHXM'), '2017/09/11', -0.004595383750330095),
(symbol('TAHO'), '2017/09/11', -0.0093951124176593),
(symbol('COOL'), '2017/09/14', -0.004922640624600762),
(symbol('DJCO'), '2017/09/14', -0.010756108469095568),
(symbol('DO'), '2017/09/25', -0.00269379460040788),
(symbol('CMTA'), '2017/09/27', -0.008484703435922458),
(symbol('MARK'), '2017/09/27', -0.004979278052195509),
(symbol('ZYNE'), '2017/09/28', -0.016200643678329876),
(symbol('CONN'), '2017/09/29', -0.0021557599753335007),
(symbol('NC'), '2017/10/02', -0.03956871063630257),
(symbol('VHC'), '2017/10/02', -0.006518739215779789),
(symbol('DEPO'), '2017/10/03', -0.002219265640086672),
(symbol('DHXM'), '2017/10/12', -0.0021557599753335007),
(symbol('SPPI'), '2017/10/18', -0.0080662139813581),
(symbol('DEL'), '2017/10/23', -0.005628032355061478),
(symbol('EXAC'), '2017/10/23', -0.017786691247018975),
(symbol('ECHO'), '2017/10/26', -0.013897371561426609),
(symbol('DAIO'), '2017/10/27', -0.0030550357717034483),
(symbol('DGII'), '2017/10/27', -0.008628938023094626),
(symbol('CPLA'), '2017/10/30', -0.008973122277427917),
(symbol('CNHI'), '2017/10/31', -0.00269379460040788),
(symbol('CTXR'), '2017/10/31', -0.07302343478891953),
(symbol('CVRR'), '2017/11/01', -0.00269379460040788),
(symbol('DHXM'), '2017/11/01', -0.005012431056194486),
(symbol('CSBK'), '2017/11/02', -0.004505593318736371),
(symbol('DRNA'), '2017/11/02', -0.0021557599753335007),
(symbol('CNTY'), '2017/11/06', -0.004010117702642219),
(symbol('TXMD'), '2017/11/06', -0.013827511289238873),
(symbol('COLL'), '2017/11/07', -0.0021557599753335007),
(symbol('CRC'), '2017/11/07', -0.0021557599753335007),
(symbol('CVGI'), '2017/11/07', -0.00269379460040788),
(symbol('CUTR'), '2017/11/08', -0.0030550357717034483),
(symbol('CVU'), '2017/11/08', -0.009439785366861228),
(symbol('MBI'), '2017/11/08', -0.006518739215779789),
(symbol('SAGE'), '2017/11/09', -0.00897806511179491),
(symbol('DHXM'), '2017/11/14', -0.0026363129459510627),
(symbol('SORL'), '2017/11/15', -0.015184085654655736),
(symbol('CTEK'), '2017/11/17', -0.007215209610791947),
(symbol('DBVT'), '2017/11/20', -0.0021557599753335007),
(symbol('CREG'), '2017/11/21', -0.08373772562103293),
(symbol('CTRN'), '2017/11/21', -0.002219265640086672),
(symbol('CUB'), '2017/11/21', -0.0030550357717034483),
(symbol('CPRT'), '2017/11/22', -0.0030550357717034483),
(symbol('CNFR'), '2017/11/27', -0.016893906603959237),
(symbol('COE'), '2017/11/27', -0.024950820088396792),
(symbol('CUDA'), '2017/11/27', -0.002113445724191603),
(symbol('SSC'), '2017/11/27', -0.05337610365668547),
(symbol('COE'), '2017/12/04', -0.017906931629834644),
(symbol('COLL'), '2017/12/05', -0.0021557599753335007),
(symbol('DEPO'), '2017/12/05', -0.0021557599753335007),
(symbol('CTXR'), '2017/12/06', -0.004486617645544026),
(symbol('CONN'), '2017/12/07', -0.0030550357717034483),
(symbol('CUTR'), '2017/12/08', -0.003110841906272271),
(symbol('DAVE'), '2017/12/08', -0.005012431056194486),
(symbol('CTXR'), '2017/12/11', -0.02528229088672651),
(symbol('DAVE'), '2017/12/11', -0.013066214020842258),
(symbol('DPLO'), '2017/12/11', -0.0021557599753335007),
(symbol('DQ'), '2017/12/11', -0.0021557599753335007),
(symbol('CORT'), '2017/12/21', -0.0021557599753335007),
(symbol('DHXM'), '2017/12/21', -0.005862057373827371),
(symbol('DJCO'), '2017/12/21', -0.010756108469095568),
(symbol('GNRT'), '2017/12/21', -0.013897371561426609),
(symbol('DCIX'), '2017/12/22', -0.017872095128068026),
(symbol('CRVS'), '2017/12/27', -0.007575225297211369),
(symbol('LIVE'), '2017/12/28', -0.016200643678329876),
(symbol('COGT'), '2018/01/04', -0.0021557599753335007),
(symbol('CYAD'), '2018/01/04', -0.023112574417661343),
(symbol('COGT'), '2018/01/10', -0.019092048019947364),
(symbol('CPAH'), '2018/01/10', -0.029444889045850554),
(symbol('CYAD'), '2018/01/10', -0.023112574417661343),
(symbol('CPAH'), '2018/01/11', -0.03014263746711518),
(symbol('CTXR'), '2018/01/11', -0.005012431056194486),
(symbol('CYH'), '2018/01/11', -0.0021557599753335007),
(symbol('SECO'), '2018/01/11', -0.011230391312304147),
(symbol('CTIC'), '2018/01/12', -0.0035355887423210107),
(symbol('DF'), '2018/01/17', -0.00269379460040788),
(symbol('JUNO'), '2018/01/17', -0.03233259596921148),
(symbol('NEWA'), '2018/01/17', -0.03361503239583725),
(symbol('CTIC'), '2018/01/18', -0.0030562457508729194),
(symbol('CRBP'), '2018/01/19', -0.0021557599753335007),
(symbol('CRSP'), '2018/01/23', -0.0021557599753335007),
(symbol('CRI'), '2018/01/25', -0.002113445724191603),
(symbol('DPS'), '2018/01/29', -0.00398761602498685),
(symbol('IMMR'), '2018/01/29', -0.006162802578392328),
(symbol('KS'), '2018/01/29', -0.008354018110424634),
(symbol('CRBP'), '2018/01/30', -0.0021557599753335007),
(symbol('CWBC'), '2018/01/30', -0.040464876893252094),
(symbol('CORT'), '2018/02/01', -0.0057343142692027164),
        ]
    
    #set_slippage(slippage.FixedSlippage(spread=0.005))  
    #set_commission(commission.PerTrade(cost=2.50))  

    ## エントリー
    context.orders = list()
    context.values = dict()
    algo.schedule_function(
        rebalance,
        algo.date_rules.every_day(),
        algo.time_rules.market_open(minutes=5),
    )

    algo.schedule_function(
        closeAnyOpenOrders,
        algo.date_rules.every_day(),
        algo.time_rules.market_open(minutes=10),
    )

    ## クローズ
    algo.schedule_function(
        all_close,
        algo.date_rules.every_day(),
        algo.time_rules.market_open(minutes=40),
    )
    
    # Record tracking variables at the end of each day.
    algo.schedule_function(
        record_vars,
        algo.date_rules.every_day(),
        algo.time_rules.market_close(),
    )

    # Create our dynamic stock selector.
    #algo.attach_pipeline(make_pipeline(), 'pipeline')


def before_trading_start(context, data):
    
    context.values = dict()
    # check if no position is held 
    if len(context.portfolio.positions) > 0:
        log.warn("Current Positions: {}".format(len(context.portfolio.positions)))

    
def rebalance(context, data):
    today = get_datetime('US/Eastern').strftime("%Y/%m/%d")
    todays_order = []
    context.orders = []
    for s,d,p in context.sid_date_list:
        #log.info(d)
        if d == today:
            todays_order.append((s, p))
    n = 2
    if len(todays_order)>0:
        log.info('today: {} {} candidates'.format(today, len(todays_order)))
        todays_order = sorted(todays_order, key=lambda x: x[1])[0:n]
        
        for s, p in todays_order:
            if data.can_trade(s):
                log.info('trade: {} {}'.format(s, p))
                order_id = order_target_percent(s, -1.0/max(len(todays_order), n)*0.9)
                context.orders.append(order_id)

                
def closeAnyOpenOrders(context, data):  
    for order_id in context.orders:
        orderobj = get_order(order_id)
        if orderobj.status == 0:  
            message = 'Canceling order for {} shares in {}'.format(orderobj.amount, orderobj.sid.symbol)  
            log.info(message)  
            cancel_order(orderobj)              


        
def all_close(context, data):
    for s in context.portfolio.positions:
        order_target(s, 0)


def handle_data(context, data): 
    for order_id in context.orders:
        orderobj = get_order(order_id)
        if orderobj.status == 1:#filled 
            s = orderobj.sid
            sold_price = context.portfolio.positions[s].cost_basis
            current_price = data.current(s, fields='price') 
            
            if s not in context.values.keys():
                context.values[s] = sold_price
            else:
                if current_price > context.values[s] * (1 + context.trailingstop_ratio):
                    log.info("Trailing Stop {}".format(s.symbol))
                    if data.can_trade(s): 
                        order_target(s, 0) 
                        context.orders.remove(order_id)
                    else:log.warn("Cannot order Trailing Stop {}".format(s.symbol))                        
                else:
                    context.values[s] = current_price
                    
                    
            

def record_vars(context, data):
    """
    Plot variables at the end of each day.0
    """
    pass

